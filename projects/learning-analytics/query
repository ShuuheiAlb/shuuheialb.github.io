
-- Database: junyi_data

-- DROP DATABASE IF EXISTS junyi_data;

CREATE DATABASE junyi_data
    WITH
    OWNER = rotisayabundar
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_AU.UTF-8'
    LC_CTYPE = 'en_AU.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1
    IS_TEMPLATE = False;


-- Copy tables

show data_directory;
create table info_content (
 ucid char(44) primary key, content_pretty_name varchar, translation_ms_word varchar,
 content_kind varchar default 'Exercise', difficulty varchar, subject varchar default 'math',
 learning_stage	varchar, level1_id char(44), level2_id	char(44), level2_topic varchar,
 level3_id	char(44), level4_id char(44)
);
create table info_userdata (
 uuid char(44) primary key, gender varchar, points int, badges_cnt int, first_login_date_TW date,
 user_grade	int, user_city varchar, has_teacher_cnt int, is_self_coach bool,
 has_student_cnt int, belongs_to_class_cnt int, has_class_cnt int
);
create table log_problem (
 timestamp_TW date, uuid char(44), ucid	char(44), upid char(44),
 problem_number int, exercise_problem_repeat_session int,
 is_correct	bool, total_sec_taken int, total_attempt_cnt int, used_hint_cnt int,
 is_hint_used bool, is_downgrade bool, is_upgrade bool, "level" int
);

copy info_content FROM '/home/rotisayabundar/Downloads/shuuheialb.github.io/projects/learning-analytics/junyi_data/Info_Content.csv' csv header;
copy info_userdata FROM '/home/rotisayabundar/Downloads/shuuheialb.github.io/projects/learning-analytics/junyi_data/Info_UserData.csv' csv header;
copy log_problem FROM '/home/rotisayabundar/Downloads/shuuheialb.github.io/projects/learning-analytics/junyi_data/Log_Problem.csv' csv header;

--------------------------------








-- Success rate at around 60-70%
-- Unset senior has very low success
-- Note: 1Ez : geometry, 7f7: basic num, ICg: alg, jXS: stats
-- 

select learning_stage, difficulty, level2_id, is_correct, count(is_correct) as num,
	count(is_correct) * 100.0 / sum(count(is_correct)) over (partition by learning_stage, difficulty, level2_id) as perc 
	from public.log_problem
	join public.info_content on (log_problem.ucid = info_content.ucid)
	group by learning_stage, difficulty, level2_id, is_correct

# --

select * from public.log_problem
	where total_attempt_cnt > 100
	
SELECT distinct date_part(year, timestamp_tw), date_part(month, timestamp_tw) FROM public.log_problem
group by timestamp_tw
LIMIT 100